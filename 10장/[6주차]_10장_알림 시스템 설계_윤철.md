# 알림 시스템 설계
* 알림 시스템은 고객에게 중요할만한 정보를 비동기적으로 제공한다.
* 같은 고객에 대해서 너무 많은 알림을 발송하는 경우 피로감을 줄 수 있기 때문에 알림 수신을 거부할 수 있기 때문에 유저마다 적절한 알림 횟수로 제한해야 한다. 
* 서비스의 규모와 특성에 따라 대량의 트래픽을 발생시킬 수 있기 때문에 주의해야 한다.
* 크게 푸시 알림, SMS 메시지, e-mail 알림으로 분류할 수 있다.

## 알림 유형별 지원 방안
### iOS 푸시 알림
* iOS 에서 푸시 알림을 보내기 위해서는 세 가지 컴포넌트가 필요하다.
* 알림 제공자: 알림 요청을 만들어 애플 푸시 알림 서비스(APNS: Apple Push Notification Service)로 보내는 주체다.
* APNS: 애플이 제공하는 원격 서비스이며, 푸시 알림을 iOS 장치로 보내는 역할을 한다.
* iOS 단말: 푸시 알림을 수신하는 사용자 단말이다.

### 안드로이드 푸시 알림
* 안드로이드 알림은 iOS 푸시와 비슷한 절차로 전송하며, APNS 대신 FCM(Firebase Cloud Messaging)을 사용하는 점만 다르다.

### SMS 메시지
* 뿌리오, 알리고 등 제 3 사업자의 서비스를 이용하여 보낸다.

### 이메일
* 회사에서 구축한 메일 서버를 이용해서 전송하거나 aws의 SES(Simple Email Service), 메일침프(Mailchimp) 등을 이용하여 전송한다.

## 알림 서비스 구성
![첫 번째 설계](./images/first_designed_notification.png)
* 각 서비스들은 MSA 로 분리되어 있고, 필요에 따라 알림 시스템으로 알림 전송 요청을 보낸다.
* 알림 시스템은 각 서비스들에게 받은 요청에 대해서 메시지를 생성하고 제 3자 서비스로 알림 발송 요청을 보낸다.
* 제 3자 제공 서비스는 자신의 벤더사로 적절하게 알림을 보내는 역할을 한다.

### 위 구성의 문제점
* 알림 발송은 수신하는 사용자를 정의하는 세그먼트에 따라 대량의 트래픽을 발생시킬 수 있다.
* 대량의 알림 발송이 진행되는 경우, 알림 시스템은 SPOF 지점이 되어 장애가 발생하면 그 여파가 다른 시스템에 전파될 여지가 있다.

### 두 번째 개선
![두 번째 설계](./images/second_designed_notification.png)
* 데이터베이스와 캐시 서버를 분리하여 적절한 캐싱전략을 통해 I/O 부하를 줄인다.
  * 만약 캐싱되는 알림 템플릿 데이터가 거대한 경우, 압축 전략을 통해 적재되는 데이터의 양을 줄이고, 네트워크 I/O 부하를 줄이는 대신 CPU 를 좀더 인텐시브하게 사용하는 방법을 활용해볼 수 있다.
  * CPU 인텐시브한 설계는 알림 서비스가 수평 확장에 유리하게 만들어준다.
* 메시지 큐를 이용하여 시스템 컴포넌트 사이의 강한 결합을 끊어냈다.
  * 다량의 알림을 발송해야 하는 경우의 버퍼 역할을 하기도 한다.
* 메시지 큐를 종류별로 분리하였기 때문에 제 3자 서비스 중 한 곳의 장애가 다른 서비스로 전파되는걸 방지한다.
* 작업 서버는 메시지 큐에서 컨슈밍하여 제 3자 서비스로 전달하는 역할을 한다.
  * 작업 서버는 알림 로그 데이터베이스를 두고, 발송 실패에 대한 재시도 메커니즘을 구현할 수 있다.
  * 이벤트 ID 를 검사하여 한 번 전송되었던 알림을 중복 전송하는 빈도수를 줄일 수 있다. (분산 시스템에서 완전하게 막는 것은 가능하지 않다.)

### 그 밖의 고려 사항
* 템플릿을 사용하여 특정 양식의 데이터를 일관성 있게 유지할 수 있도록 한다.
* 사용자가 원하는 알림을 받을 수 있도록 알림 설정을 상세히 조정하고, 이에 대한 설정 테이블을 보관하여 알림 발송을 진행할지 여부를 판단하는 구성이 필요하다.
* 사용자에게 너무 많은 알림이 가지 않도록 알림 시스템에서 전송률을 제한하는 것도 고려해야 한다.
* 제 3자 서비스에 알림 발송을 실패하면 해당 알림을 재시도 전용 큐에 넣고, 지속적으로 발생하면 개발자에게 통지 할 수 있도록 고려해야 한다.
* 큐에 쌓인 알림의 개수를 파악할 수 있는 메트릭을 구성할 수 있도록 모니터링 구축을 고려한다.
* 알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 같은 메트릭을 구축하여 데이터 분석을 용이하게 할 수 있도록 고려한다.
